# æ—¥å¿—è®°å½•å’Œé”™è¯¯æ’æŸ¥æŒ‡å—

## ğŸ“ æ—¥å¿—è®°å½•ä½ç½®

### 1. å¼€å‘ç¯å¢ƒï¼ˆæœ¬åœ°ï¼‰

**æ§åˆ¶å°è¾“å‡ºï¼š**
- æ‰€æœ‰ `console.log()`, `console.error()`, `console.warn()` ä¼šè¾“å‡ºåˆ°ç»ˆç«¯
- è¿è¡Œ `pnpm dev` æ—¶ï¼Œæ—¥å¿—ä¼šå®æ—¶æ˜¾ç¤ºåœ¨ç»ˆç«¯

**æŸ¥çœ‹æ–¹å¼ï¼š**
```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# æ—¥å¿—ä¼šå®æ—¶æ˜¾ç¤ºåœ¨ç»ˆç«¯ï¼ŒåŒ…æ‹¬ï¼š
# - API è¯·æ±‚æ—¥å¿—
# - é”™è¯¯ä¿¡æ¯
# - è­¦å‘Šä¿¡æ¯
# - è°ƒè¯•ä¿¡æ¯
```

### 2. ç”Ÿäº§ç¯å¢ƒ

#### 2.1 Vercel éƒ¨ç½²

**Vercel æ—¥å¿—ï¼š**
- ç™»å½• [Vercel Dashboard](https://vercel.com/dashboard)
- é€‰æ‹©ä½ çš„é¡¹ç›®
- ç‚¹å‡» **"Deployments"** â†’ é€‰æ‹©éƒ¨ç½² â†’ ç‚¹å‡» **"Functions"** æ ‡ç­¾
- æˆ–è€…ç‚¹å‡» **"Logs"** æŸ¥çœ‹å®æ—¶æ—¥å¿—

**æŸ¥çœ‹æ–¹å¼ï¼š**
1. è®¿é—® Vercel Dashboard
2. é€‰æ‹©é¡¹ç›®
3. è¿›å…¥ **Deployments** é¡µé¢
4. ç‚¹å‡»å…·ä½“çš„éƒ¨ç½²ç‰ˆæœ¬
5. æŸ¥çœ‹ **Functions** æˆ– **Logs** æ ‡ç­¾

#### 2.2 PM2 æœåŠ¡å™¨éƒ¨ç½²

**PM2 æ—¥å¿—ä½ç½®ï¼š**

PM2 **é»˜è®¤ä¼šè‡ªåŠ¨å°†æ—¥å¿—è¾“å‡ºåˆ°æ–‡ä»¶**ï¼Œæœ‰ä¸¤ç§é…ç½®æ–¹å¼ï¼š

**æ–¹å¼ 1ï¼šä½¿ç”¨ ecosystem.config.js é…ç½®ï¼ˆæ¨èï¼‰**

æ ¹æ®é¡¹ç›®ä¸­çš„ `ecosystem.config.js` é…ç½®ï¼š
- **é”™è¯¯æ—¥å¿—ï¼š** `./logs/bible-video-error.log` (é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ logs æ–‡ä»¶å¤¹)
- **æ ‡å‡†è¾“å‡ºï¼š** `./logs/bible-video-out.log`
- **åˆå¹¶æ—¥å¿—ï¼š** `./logs/bible-video-combined.log`

**æ–¹å¼ 2ï¼šPM2 é»˜è®¤ä½ç½®ï¼ˆå¦‚æœæœªé…ç½®ï¼‰**

å¦‚æœæœªåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæ—¥å¿—è·¯å¾„ï¼ŒPM2 ä¼šä½¿ç”¨é»˜è®¤ä½ç½®ï¼š
- **é»˜è®¤æ—¥å¿—ç›®å½•ï¼š** `~/.pm2/logs/`
- **åº”ç”¨æ—¥å¿—æ–‡ä»¶ï¼š** `~/.pm2/logs/[app-name]-out.log` (æ ‡å‡†è¾“å‡º)
- **é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼š** `~/.pm2/logs/[app-name]-error.log` (é”™è¯¯è¾“å‡º)

**æŸ¥çœ‹æ—¥å¿—å‘½ä»¤ï¼š**

```bash
# æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çš„æ—¥å¿—
pm2 logs

# æŸ¥çœ‹ç‰¹å®šåº”ç”¨çš„æ—¥å¿—
pm2 logs [app-name]

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—ï¼ˆæœ€å 100 è¡Œï¼‰
pm2 logs --lines 100

# åªæŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs --err

# åªæŸ¥çœ‹æ ‡å‡†è¾“å‡ºæ—¥å¿—
pm2 logs --out

# å®æ—¶æŸ¥çœ‹æ—¥å¿—ï¼ˆç±»ä¼¼ tail -fï¼‰
pm2 logs --lines 0

# æ¸…ç©ºæ‰€æœ‰æ—¥å¿—
pm2 flush

# æŸ¥çœ‹ç‰¹å®šåº”ç”¨çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶
tail -f ~/.pm2/logs/[app-name]-error.log

# æŸ¥çœ‹ç‰¹å®šåº”ç”¨çš„æ ‡å‡†è¾“å‡ºæ—¥å¿—æ–‡ä»¶
tail -f ~/.pm2/logs/[app-name]-out.log
```

**PM2 å¸¸ç”¨å‘½ä»¤ï¼š**

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿è¡Œä¸­çš„åº”ç”¨
pm2 list

# æŸ¥çœ‹åº”ç”¨è¯¦ç»†ä¿¡æ¯
pm2 show [app-name]

# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
pm2 status

# é‡å¯åº”ç”¨
pm2 restart [app-name]

# åœæ­¢åº”ç”¨
pm2 stop [app-name]

# åˆ é™¤åº”ç”¨
pm2 delete [app-name]

# æŸ¥çœ‹åº”ç”¨ç›‘æ§ä¿¡æ¯
pm2 monit

# ä¿å­˜å½“å‰ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 save

# è®¾ç½® PM2 å¼€æœºè‡ªå¯
pm2 startup
```

**åœ¨æ—¥å¿—ä¸­æœç´¢é”™è¯¯ï¼š**

```bash
# æœç´¢é”™è¯¯æ—¥å¿—
grep -i "error\|failed" ~/.pm2/logs/[app-name]-error.log

# æœç´¢ç‰¹å®šæ¨¡å—çš„æ—¥å¿—
grep "\[Volcano\]" ~/.pm2/logs/[app-name]-out.log

# æœç´¢æœ€è¿‘çš„é”™è¯¯ï¼ˆæœ€å 1000 è¡Œï¼‰
tail -n 1000 ~/.pm2/logs/[app-name]-error.log | grep -i "error"

# å®æ—¶ç›‘æ§é”™è¯¯æ—¥å¿—
tail -f ~/.pm2/logs/[app-name]-error.log | grep -i "error\|failed"
```

### 3. æœåŠ¡å™¨ç«¯æ—¥å¿—

**API è·¯ç”±æ—¥å¿—ï¼š**
æ‰€æœ‰ API è·¯ç”±çš„é”™è¯¯éƒ½ä¼šé€šè¿‡ `console.error()` è®°å½•ï¼Œä½ç½®åŒ…æ‹¬ï¼š

- `/src/app/api/**/*.ts` - API è·¯ç”±ä¸­çš„é”™è¯¯
- `/src/shared/services/**/*.ts` - æœåŠ¡å±‚é”™è¯¯
- `/src/extensions/**/*.ts` - æ‰©å±•åŠŸèƒ½é”™è¯¯

**å¸¸è§æ—¥å¿—ä½ç½®ï¼š**

| åŠŸèƒ½æ¨¡å— | æ—¥å¿—ä½ç½® | æ—¥å¿—æ ‡è¯† |
|---------|---------|---------|
| AI ä»»åŠ¡åŒæ­¥ | `src/app/api/ai/sync-pending-tasks/route.ts` | `[Sync Pending Tasks]` |
| è§†é¢‘ç”Ÿæˆ | `src/app/api/ai/generate/route.ts` | `[AI Generate]` |
| è§†é¢‘æŸ¥è¯¢ | `src/app/api/ai/query/route.ts` | `[AI Query]` |
| è¯„è®ºåˆ›å»º | `src/app/api/comments/create/route.ts` | `[Comments Create]` |
| è§†é¢‘åˆå¹¶ | `src/app/api/video/merge/route.ts` | `[Video Merge]` |
| ç«å±±å¼•æ“ | `src/extensions/ai/volcano.ts` | `[Volcano]` |

### 4. å®¢æˆ·ç«¯æ—¥å¿—

**æµè§ˆå™¨æ§åˆ¶å°ï¼š**
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
- æŸ¥çœ‹ **Console** æ ‡ç­¾
- å‰ç«¯é”™è¯¯ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ

**é”™è¯¯è¾¹ç•Œï¼š**
- `/src/shared/blocks/common/error-boundary.tsx` - æ•è· React ç»„ä»¶é”™è¯¯
- é”™è¯¯ä¼šé€šè¿‡ `console.error()` è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°

## ğŸ” å¦‚ä½•æ’æŸ¥é”™è¯¯

### æ­¥éª¤ 1: ç¡®å®šé”™è¯¯ç±»å‹

**å‰ç«¯é”™è¯¯ï¼š**
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
- æŸ¥çœ‹ Console æ ‡ç­¾ä¸­çš„çº¢è‰²é”™è¯¯ä¿¡æ¯
- æŸ¥çœ‹ Network æ ‡ç­¾ä¸­çš„å¤±è´¥è¯·æ±‚

**åç«¯é”™è¯¯ï¼š**
- **Vercel éƒ¨ç½²ï¼š** æŸ¥çœ‹ Vercel Dashboard æ—¥å¿—
- **PM2 éƒ¨ç½²ï¼š** ä½¿ç”¨ `pm2 logs` å‘½ä»¤æŸ¥çœ‹æ—¥å¿—
- **æœ¬åœ°å¼€å‘ï¼š** æŸ¥çœ‹ç»ˆç«¯è¾“å‡º
- æŸ¥æ‰¾å¸¦æœ‰ `[Error]` æˆ– `[Failed]` æ ‡è¯†çš„æ—¥å¿—

### æ­¥éª¤ 2: æŸ¥æ‰¾é”™è¯¯æ—¥å¿—

**æœç´¢å…³é”®è¯ï¼š**
```bash
# åœ¨æ—¥å¿—ä¸­æœç´¢ï¼š
- "Error"
- "Failed"
- "Exception"
- "[æ¨¡å—å]" (å¦‚ "[Volcano]", "[Sync Pending Tasks]")

# PM2 ä¸­æœç´¢ï¼š
pm2 logs | grep -i "error\|failed"
pm2 logs | grep "\[Volcano\]"
```

**å¸¸è§é”™è¯¯æ ‡è¯†ï¼š**
- `[Sync Pending Tasks] Failed:` - å®šæ—¶ä»»åŠ¡åŒæ­¥å¤±è´¥
- `[Volcano] Failed to` - ç«å±±å¼•æ“ API é”™è¯¯
- `[Video Merge] Failed to` - è§†é¢‘åˆå¹¶å¤±è´¥
- `[Comments Create]` - è¯„è®ºåˆ›å»ºé”™è¯¯
- `[AI Generate]` - AI ç”Ÿæˆé”™è¯¯

### æ­¥éª¤ 3: åˆ†æé”™è¯¯ä¿¡æ¯

**é”™è¯¯æ—¥å¿—æ ¼å¼ï¼š**
```javascript
console.error('[æ¨¡å—å] æ“ä½œæè¿°:', error);
// ä¾‹å¦‚ï¼š
console.error('[Volcano] Failed to auto-enhance prompt:', error);
```

**æŸ¥çœ‹å®Œæ•´é”™è¯¯å †æ ˆï¼š**
- é”™è¯¯å¯¹è±¡é€šå¸¸åŒ…å« `message` å’Œ `stack` å±æ€§
- æŸ¥çœ‹å †æ ˆä¿¡æ¯å¯ä»¥å®šä½åˆ°å…·ä½“çš„ä»£ç è¡Œ

### æ­¥éª¤ 4: æ£€æŸ¥ç›¸å…³é…ç½®

**ç¯å¢ƒå˜é‡ï¼š**
```bash
# æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„é…ç½®
- DATABASE_URL
- VOLCANO_API_KEY
- VOLCANO_DOUBAO_ENDPOINT
- R2_BUCKET_NAME
- NEXT_PUBLIC_CDN_DOMAIN
```

**æ•°æ®åº“è¿æ¥ï¼š**
- æ£€æŸ¥ `DATABASE_URL` æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æ•°æ®åº“è¿æ¥æ± è®¾ç½®ï¼ˆ`DB_SINGLETON_ENABLED`, `DB_MAX_CONNECTIONS`ï¼‰

**API å¯†é’¥ï¼š**
- æ£€æŸ¥å„ç§ API å¯†é’¥æ˜¯å¦é…ç½®æ­£ç¡®
- æ£€æŸ¥ API å¯†é’¥æ˜¯å¦è¿‡æœŸ

### æ­¥éª¤ 5: æŸ¥çœ‹ç›¸å…³ä»£ç 

**å®šä½é”™è¯¯ä»£ç ï¼š**
1. æ ¹æ®é”™è¯¯æ—¥å¿—ä¸­çš„æ¨¡å—åæ‰¾åˆ°å¯¹åº”æ–‡ä»¶
2. æŸ¥çœ‹é”™è¯¯å‘ç”Ÿçš„å…·ä½“ä½ç½®
3. æ£€æŸ¥é”™è¯¯å¤„ç†é€»è¾‘

**ç¤ºä¾‹ï¼š**
```typescript
// å¦‚æœçœ‹åˆ°é”™è¯¯ï¼š[Volcano] Failed to auto-enhance prompt
// 1. æ‰¾åˆ°æ–‡ä»¶ï¼šsrc/extensions/ai/volcano.ts
// 2. æœç´¢ "Failed to auto-enhance prompt"
// 3. æŸ¥çœ‹è¯¥ä½ç½®çš„ä»£ç å’Œé”™è¯¯å¤„ç†
```

## ğŸ› ï¸ å¸¸è§é”™è¯¯æ’æŸ¥

### 1. æ•°æ®åº“è¿æ¥é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Error [PostgresError]: remaining connection slots are reserved
```

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥ `DB_SINGLETON_ENABLED=true` æ˜¯å¦è®¾ç½®
2. æ£€æŸ¥ `DB_MAX_CONNECTIONS` æ˜¯å¦åˆç†ï¼ˆå»ºè®® 10ï¼‰
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸

### 2. API è°ƒç”¨å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
[Volcano] Failed to auto-enhance prompt: Error: Chat completion failed with status: 400
```

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ API ç«¯ç‚¹ URL æ˜¯å¦æ­£ç¡®
3. æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼æ˜¯å¦æ­£ç¡®
4. æŸ¥çœ‹ API æä¾›å•†çš„é”™è¯¯ä¿¡æ¯

### 3. æ–‡ä»¶ä¸Šä¼ å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š**
```
[Video Merge] Failed to merge videos: Error: fetch failed
```

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥ R2 å­˜å‚¨é…ç½®æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
4. æŸ¥çœ‹ R2 å­˜å‚¨æœåŠ¡çš„é”™è¯¯ä¿¡æ¯

### 4. å‰ç«¯é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
Uncaught error: TypeError: Cannot read property 'xxx' of undefined
```

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
2. æŸ¥çœ‹ Console ä¸­çš„å®Œæ•´é”™è¯¯å †æ ˆ
3. æ£€æŸ¥ç›¸å…³ç»„ä»¶çš„ä»£ç 
4. æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®ä¼ é€’

## ğŸ“Š æ—¥å¿—çº§åˆ«

å½“å‰é¡¹ç›®ä½¿ç”¨çš„æ—¥å¿—çº§åˆ«ï¼š

| çº§åˆ« | æ–¹æ³• | ç”¨é€” |
|-----|------|------|
| **Error** | `console.error()` | é”™è¯¯ä¿¡æ¯ï¼Œéœ€è¦ç«‹å³å…³æ³¨ |
| **Warn** | `console.warn()` | è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½çš„é—®é¢˜ |
| **Info** | `console.log()` | ä¸€èˆ¬ä¿¡æ¯ï¼Œè°ƒè¯•ç”¨ |

## ğŸ”§ æ”¹è¿›å»ºè®®

### 1. æ·»åŠ ç»“æ„åŒ–æ—¥å¿—

è€ƒè™‘ä½¿ç”¨æ—¥å¿—åº“ï¼ˆå¦‚ `winston` æˆ– `pino`ï¼‰æ¥ï¼š
- ç»Ÿä¸€æ—¥å¿—æ ¼å¼
- æ”¯æŒæ—¥å¿—çº§åˆ«
- æ”¯æŒæ—¥å¿—æ–‡ä»¶è¾“å‡º
- æ”¯æŒæ—¥å¿—è½®è½¬

### 2. æ·»åŠ é”™è¯¯è¿½è¸ªæœåŠ¡

è€ƒè™‘é›†æˆé”™è¯¯è¿½è¸ªæœåŠ¡ï¼ˆå¦‚ Sentryï¼‰ï¼š
- è‡ªåŠ¨æ•è·é”™è¯¯
- é”™è¯¯é€šçŸ¥
- é”™è¯¯åˆ†æ
- æ€§èƒ½ç›‘æ§

### 3. æ·»åŠ è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶

åœ¨ API è·¯ç”±ä¸­æ·»åŠ è¯·æ±‚æ—¥å¿—ï¼š
- è®°å½•è¯·æ±‚ URL
- è®°å½•è¯·æ±‚å‚æ•°
- è®°å½•å“åº”çŠ¶æ€
- è®°å½•å“åº”æ—¶é—´

## ğŸ“ æ—¥å¿—è®°å½•æœ€ä½³å®è·µ

1. **ä½¿ç”¨æœ‰æ„ä¹‰çš„æ—¥å¿—æ ‡è¯†**
   ```typescript
   console.error('[æ¨¡å—å] æ“ä½œæè¿°:', error);
   ```

2. **è®°å½•å…³é”®ä¿¡æ¯**
   ```typescript
   console.error('[Volcano] Failed to generate video:', {
     taskId: task.id,
     provider: task.provider,
     error: error.message
   });
   ```

3. **åŒºåˆ†æ—¥å¿—çº§åˆ«**
   - é”™è¯¯ï¼šä½¿ç”¨ `console.error()`
   - è­¦å‘Šï¼šä½¿ç”¨ `console.warn()`
   - ä¿¡æ¯ï¼šä½¿ç”¨ `console.log()`

4. **é¿å…è®°å½•æ•æ„Ÿä¿¡æ¯**
   - ä¸è¦è®°å½•å¯†ç ã€API å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯
   - ä¸è¦è®°å½•å®Œæ•´çš„ç”¨æˆ·æ•°æ®

## ğŸš€ å¿«é€Ÿæ’æŸ¥å‘½ä»¤

### å¼€å‘ç¯å¢ƒ

```bash
# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—ï¼ˆæœ¬åœ°å¼€å‘ï¼‰
pnpm dev | grep -i "error\|failed"

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—çš„æ—¥å¿—
pnpm dev | grep "\[Volcano\]"

# æŸ¥çœ‹æ•°æ®åº“ç›¸å…³é”™è¯¯
pnpm dev | grep -i "database\|postgres"
```

### PM2 ç”Ÿäº§ç¯å¢ƒ

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
pm2 logs bible-video

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
pm2 logs bible-video --err

# æœç´¢é”™è¯¯
pm2 logs bible-video | grep -i "error\|failed"

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—çš„æ—¥å¿—
pm2 logs bible-video | grep "\[Volcano\]"

# æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯ï¼ˆæœ€å 500 è¡Œï¼‰
pm2 logs bible-video --lines 500 --err

# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼ˆä½¿ç”¨é…ç½®çš„è·¯å¾„ï¼‰
tail -f ./logs/bible-video-error.log
tail -f ./logs/bible-video-out.log

# æˆ–è€…ä½¿ç”¨ PM2 é»˜è®¤è·¯å¾„
tail -f ~/.pm2/logs/bible-video-error.log
tail -f ~/.pm2/logs/bible-video-out.log

# åœ¨æ—¥å¿—æ–‡ä»¶ä¸­æœç´¢ï¼ˆä½¿ç”¨é…ç½®çš„è·¯å¾„ï¼‰
grep -i "error" ./logs/bible-video-error.log
grep "\[Volcano\]" ./logs/bible-video-out.log

# æˆ–è€…ä½¿ç”¨ PM2 é»˜è®¤è·¯å¾„
grep -i "error" ~/.pm2/logs/bible-video-error.log
grep "\[Volcano\]" ~/.pm2/logs/bible-video-out.log
```

## ğŸ“¦ PM2 éƒ¨ç½²é…ç½®

### åˆ›å»º PM2 é…ç½®æ–‡ä»¶

é¡¹ç›®å·²åŒ…å« `ecosystem.config.js` é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«ï¼š
- åº”ç”¨åç§°å’Œå¯åŠ¨è„šæœ¬
- æ—¥å¿—æ–‡ä»¶é…ç½®ï¼ˆé”™è¯¯æ—¥å¿—ã€æ ‡å‡†è¾“å‡ºæ—¥å¿—ï¼‰
- è‡ªåŠ¨é‡å¯é…ç½®
- å†…å­˜é™åˆ¶é…ç½®
- **å®šæ—¶ä»»åŠ¡é…ç½®**ï¼ˆåŒæ­¥æœªå®Œæˆä»»åŠ¡ï¼‰

### å®šæ—¶ä»»åŠ¡é…ç½®

**é‡è¦ï¼š** `vercel.json` ä¸­çš„ `crons` é…ç½®**åªåœ¨ Vercel å¹³å°æœ‰æ•ˆ**ã€‚å¦‚æœä½¿ç”¨ PM2 éƒ¨ç½²ï¼Œéœ€è¦å•ç‹¬é…ç½®å®šæ—¶ä»»åŠ¡ã€‚

**PM2 å®šæ—¶ä»»åŠ¡æ–¹æ¡ˆï¼š**

é¡¹ç›®å·²é…ç½® PM2 å®šæ—¶ä»»åŠ¡ï¼Œåœ¨ `ecosystem.config.js` ä¸­åŒ…å«ï¼š
- **åº”ç”¨è¿›ç¨‹ï¼š** `bible-video` - ä¸»åº”ç”¨
- **å®šæ—¶ä»»åŠ¡ï¼š** `sync-pending-tasks` - æ¯ 10 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡æœªå®Œæˆä»»åŠ¡

**å®šæ—¶ä»»åŠ¡é…ç½®è¯´æ˜ï¼š**
```javascript
{
  name: 'sync-pending-tasks',
  script: 'npx',
  args: 'tsx scripts/sync-pending-tasks.ts',
  cron_restart: '*/10 * * * *',  // æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  autorestart: false,             // å®šæ—¶ä»»åŠ¡ä¸éœ€è¦è‡ªåŠ¨é‡å¯
}
```

**Cron æ ¼å¼è¯´æ˜ï¼š**
- `*/10 * * * *` = æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- `0 */1 * * *` = æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
- `0 0 * * *` = æ¯å¤©åˆå¤œæ‰§è¡Œ
- `0 0 * * 0` = æ¯å‘¨æ—¥åˆå¤œæ‰§è¡Œ

### ä½¿ç”¨ PM2 éƒ¨ç½²æ­¥éª¤

```bash
# 1. å®‰è£… PM2ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
npm install -g pm2

# 2. æ„å»ºé¡¹ç›®
pnpm build

# 3. å¯åŠ¨æ‰€æœ‰åº”ç”¨ï¼ˆåŒ…æ‹¬å®šæ—¶ä»»åŠ¡ï¼‰
pm2 start ecosystem.config.js

# æˆ–è€…åªå¯åŠ¨ä¸»åº”ç”¨
pm2 start ecosystem.config.js --only bible-video

# 4. æŸ¥çœ‹æ‰€æœ‰åº”ç”¨çŠ¶æ€
pm2 list
pm2 status

# 5. æŸ¥çœ‹æ—¥å¿—
pm2 logs bible-video                    # ä¸»åº”ç”¨æ—¥å¿—
pm2 logs sync-pending-tasks             # å®šæ—¶ä»»åŠ¡æ—¥å¿—
pm2 logs                                # æ‰€æœ‰åº”ç”¨æ—¥å¿—

# 6. æŸ¥çœ‹å®šæ—¶ä»»åŠ¡çŠ¶æ€
pm2 show sync-pending-tasks

# 7. æ‰‹åŠ¨æ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼ˆæµ‹è¯•ç”¨ï¼‰
pm2 restart sync-pending-tasks

# 8. ä¿å­˜ PM2 è¿›ç¨‹åˆ—è¡¨
pm2 save

# 9. è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
# ç„¶åæ‰§è¡Œè¾“å‡ºçš„å‘½ä»¤
```

### å®šæ—¶ä»»åŠ¡çš„å…¶ä»–è¿è¡Œæ–¹å¼

**æ–¹å¼ 1ï¼šä½¿ç”¨ PM2 Cronï¼ˆæ¨èï¼‰**
- å·²åœ¨ `ecosystem.config.js` ä¸­é…ç½®
- ä½¿ç”¨ `pm2 start ecosystem.config.js` å¯åŠ¨æ‰€æœ‰åº”ç”¨å’Œå®šæ—¶ä»»åŠ¡

**æ–¹å¼ 2ï¼šä½¿ç”¨ç³»ç»Ÿ Cron**
```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰
*/10 * * * * cd /path/to/bible-video && npx tsx scripts/sync-pending-tasks.ts >> ./logs/cron-sync.log 2>&1
```

**æ–¹å¼ 3ï¼šæ‰‹åŠ¨è¿è¡Œï¼ˆæµ‹è¯•ç”¨ï¼‰**
```bash
# ç›´æ¥è¿è¡Œè„šæœ¬
npx tsx scripts/sync-pending-tasks.ts
```

### PM2 æ—¥å¿—æ–‡ä»¶ä½ç½®

æ ¹æ® `ecosystem.config.js` é…ç½®ï¼š
- **é”™è¯¯æ—¥å¿—ï¼š** `./logs/bible-video-error.log`
- **æ ‡å‡†è¾“å‡ºï¼š** `./logs/bible-video-out.log`
- **åˆå¹¶æ—¥å¿—ï¼š** `./logs/bible-video-combined.log`

**é»˜è®¤ PM2 æ—¥å¿—ä½ç½®ï¼ˆå¦‚æœæœªé…ç½®ï¼‰ï¼š**
- `~/.pm2/logs/bible-video-error.log`
- `~/.pm2/logs/bible-video-out.log`

### PM2 æ—¥å¿—è½®è½¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ—¥å¿—è½®è½¬ï¼Œå¯ä»¥å®‰è£… `pm2-logrotate`ï¼š

```bash
# å®‰è£… pm2-logrotate
pm2 install pm2-logrotate

# é…ç½®æ—¥å¿—è½®è½¬
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true
```

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé‡åˆ°æ— æ³•è§£å†³çš„é—®é¢˜ï¼š

1. **æŸ¥çœ‹å®Œæ•´é”™è¯¯å †æ ˆ**
2. **æ£€æŸ¥ç›¸å…³é…ç½®æ–‡ä»¶**
3. **æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—**
   - Vercel: Vercel Dashboard
   - PM2: `pm2 logs` æˆ–æ—¥å¿—æ–‡ä»¶
4. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**
5. **è”ç³»æŠ€æœ¯æ”¯æŒå¹¶æä¾›é”™è¯¯ä¿¡æ¯**

---

**æœ€åæ›´æ–°ï¼š** 2025-01-19
